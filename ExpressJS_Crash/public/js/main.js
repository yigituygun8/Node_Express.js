const output = document.querySelector("#output");
const getPostsBtn = document.querySelector("#get-posts-btn");
const addPostForm = document.querySelector("#add-post-form");

async function fetchPosts() {
    try {
        const response = await fetch("/api/posts"); // Make a GET request to the "/api/posts" endpoint to fetch the list of posts from the server. This endpoint is defined in our Express server and will return a JSON array of posts.
        if(!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`); // If the response is not successful, throw an error with a message that includes the status code. This will be caught by the catch block below and can be used to display an error message to the user.
        }
        const posts = await response.json(); // Parse the JSON response from the server and store it in the "posts" variable. This will give us an array of post objects that we can then display on the page.
        output.innerHTML = "";
        posts.forEach(post => {
            const postEl = document.createElement("div");
            postEl.textContent = `ID: ${post.id}, Title: ${post.title}`;
            output.appendChild(postEl);
        })
    } catch (error) {
        console.error("Error fetching posts:", error); // Log any errors that occur during the fetch operation to the console for debugging purposes.
        output.textContent = "Failed to fetch posts. Please try again later."; // Display a user-friendly error message in the output div if there was an error fetching the posts.
    }
}

// Submit new post
async function submitPost(event) {
    event.preventDefault(); // Prevent the default form submission behavior, which would cause the page to reload. This allows us to handle the form submission with JavaScript and send the data to the server using an AJAX request instead.
    const formData = new FormData(this); // Create a new FormData object from the form element. This will allow us to easily extract the data from the form fields and send it to the server in the correct format.
    const title = formData.get("post-title"); // Get the value of the "post-title" field from the form data. P.S. post-title is the "name" attribute of the input field in the form. This is how we can identify which field's data we want to extract from the FormData object.
    // id field is not included in the form because it will be automatically generated by the server when we create a new post. The server will assign a unique ID to each new post, so we don't need to include it in the form data when submitting a new post.
    try {
        const res = await fetch("/api/posts", {
            method: "POST", // Specify that we want to make a POST request to the server
            headers: {
                "Content-Type": "application/json" // Set the content type of the request to "application/json" since we are sending JSON data in the request body
            },
            body: JSON.stringify({ title }) // Convert the title into a JSON string and include it in the request body. This is the data that we want to send to the server to create a new post. The server will expect this data in JSON format, so we need to stringify it before sending.
        })
        if(!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        const newPost = await res.json(); // Parse the JSON response from the server, which should contain the newly created post object with its assigned ID and title.

        const postEl = document.createElement("div");
        postEl.textContent = `ID: ${newPost.post.id}, Title: ${newPost.post.title}`;
        output.appendChild(postEl); // Add the newly created post to the output div on the page so that it is immediately visible to the user without needing to refresh the page
        fetchPosts();
        // reset
        addPostForm.reset();
    } catch(error) {
        console.error("Error submitting post:", error); // Log any errors that occur during the fetch operation to the console for debugging purposes.
    }
}

// Attach Event Listeners
getPostsBtn.addEventListener("click", fetchPosts);
addPostForm.addEventListener("submit", submitPost);